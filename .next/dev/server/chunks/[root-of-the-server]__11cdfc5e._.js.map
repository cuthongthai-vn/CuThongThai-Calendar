{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 45, "column": 0}, "map": {"version":3,"sources":["file:///Users/bachpham/Documents/CuThongThai_Calendar/src/logic_processor.js"],"sourcesContent":["/**\n * logic_processor.js\n * Core logic for handling economic data comparisons and basic sentiment analysis.\n */\n\n// Utility to clean numeric strings (e.g., \"105.4K\" -> 105.4)\nfunction parseEconomicValue(valueStr) {\n    if (!valueStr || typeof valueStr !== 'string') return null;\n    \n    // Simple parser: remove commas, %, etc. Keep dots and minus.\n    // Enhanced to handle 'K', 'M', 'B' suffixes if necessary, \n    // but usually calendars provide raw numbers or consistent strings.\n    // For now, simple regex stripping.\n    const cleanStr = valueStr.replace(/[^0-9.-]/g, '');\n    const val = parseFloat(cleanStr);\n    return isNaN(val) ? null : val;\n}\n\n/**\n * Compares Actual vs Forecast to determine deviation.\n * @param {Object} event - Event object containing forecast and actual strings.\n * @returns {Object} Result containing deviation info.\n */\nfunction compareEventData(event) {\n    const { event_name, forecast, actual, previous } = event;\n\n    const forecastVal = parseEconomicValue(forecast);\n    const actualVal = parseEconomicValue(actual);\n    const previousVal = parseEconomicValue(previous);\n\n    // If data is missing\n    if (actualVal === null || forecastVal === null) {\n        return {\n            status: \"WAITING_FOR_DATA\",\n            deviation: null,\n            sentiment: \"NEUTRAL\",\n            details: \"Missing forecast or actual data\"\n        };\n    }\n\n    const deviation = actualVal - forecastVal;\n    \n    // Calculate percentage deviation if needed\n    const deviationPercent = forecastVal !== 0 ? (deviation / Math.abs(forecastVal)) * 100 : 0;\n\n    // Determine basic sentiment (This is naive and needs event-specific rules)\n    // E.g., For CPI: Actual > Forecast => Bearish for Stocks/Bullish for Currency (Inflation up)\n    // E.g., For GDP: Actual > Forecast => Bullish for Currency\n    \n    // For now, we return the raw deviation direction\n    let direction = \"EQUAL\";\n    if (deviation > 0) direction = \"HIGHER\";\n    if (deviation < 0) direction = \"LOWER\";\n\n    return {\n        status: \"COMPLETED\",\n        forecast: forecastVal,\n        actual: actualVal,\n        deviation_absolute: deviation,\n        deviation_percent: deviationPercent.toFixed(2) + '%',\n        direction: direction,\n        timestamp: new Date().toISOString()\n    };\n}\n\n/**\n * Generates a prompt for the AI based on the event data.\n */\nfunction generateAIPrompt(event, analysisResult) {\n    return `\n    Analyze the following economic event:\n    Event: ${event.event_name}\n    Currency: ${event.currency}\n    Forecast: ${event.forecast}\n    Actual: ${event.actual}\n    Deviation: ${analysisResult.direction} (${analysisResult.deviation_absolute})\n    \n    Task: Explain the potential impact of this result on:\n    1. The ${event.currency} currency strength.\n    2. The Vietnamese market (VNI index and USD/VND exchange rate).\n    Keep it concise and actionable for a trader.\n    `;\n}\n\nmodule.exports = {\n    parseEconomicValue,\n    compareEventData,\n    generateAIPrompt\n};\n"],"names":[],"mappings":"AAAA;;;CAGC,GAED,6DAA6D;AAC7D,SAAS,mBAAmB,QAAQ;IAChC,IAAI,CAAC,YAAY,OAAO,aAAa,UAAU,OAAO;IAEtD,6DAA6D;IAC7D,2DAA2D;IAC3D,mEAAmE;IACnE,mCAAmC;IACnC,MAAM,WAAW,SAAS,OAAO,CAAC,aAAa;IAC/C,MAAM,MAAM,WAAW;IACvB,OAAO,MAAM,OAAO,OAAO;AAC/B;AAEA;;;;CAIC,GACD,SAAS,iBAAiB,KAAK;IAC3B,MAAM,EAAE,UAAU,EAAE,QAAQ,EAAE,MAAM,EAAE,QAAQ,EAAE,GAAG;IAEnD,MAAM,cAAc,mBAAmB;IACvC,MAAM,YAAY,mBAAmB;IACrC,MAAM,cAAc,mBAAmB;IAEvC,qBAAqB;IACrB,IAAI,cAAc,QAAQ,gBAAgB,MAAM;QAC5C,OAAO;YACH,QAAQ;YACR,WAAW;YACX,WAAW;YACX,SAAS;QACb;IACJ;IAEA,MAAM,YAAY,YAAY;IAE9B,2CAA2C;IAC3C,MAAM,mBAAmB,gBAAgB,IAAI,AAAC,YAAY,KAAK,GAAG,CAAC,eAAgB,MAAM;IAEzF,2EAA2E;IAC3E,6FAA6F;IAC7F,2DAA2D;IAE3D,iDAAiD;IACjD,IAAI,YAAY;IAChB,IAAI,YAAY,GAAG,YAAY;IAC/B,IAAI,YAAY,GAAG,YAAY;IAE/B,OAAO;QACH,QAAQ;QACR,UAAU;QACV,QAAQ;QACR,oBAAoB;QACpB,mBAAmB,iBAAiB,OAAO,CAAC,KAAK;QACjD,WAAW;QACX,WAAW,IAAI,OAAO,WAAW;IACrC;AACJ;AAEA;;CAEC,GACD,SAAS,iBAAiB,KAAK,EAAE,cAAc;IAC3C,OAAO,CAAC;;WAED,EAAE,MAAM,UAAU,CAAC;cAChB,EAAE,MAAM,QAAQ,CAAC;cACjB,EAAE,MAAM,QAAQ,CAAC;YACnB,EAAE,MAAM,MAAM,CAAC;eACZ,EAAE,eAAe,SAAS,CAAC,EAAE,EAAE,eAAe,kBAAkB,CAAC;;;WAGrE,EAAE,MAAM,QAAQ,CAAC;;;IAGxB,CAAC;AACL;AAEA,OAAO,OAAO,GAAG;IACb;IACA;IACA;AACJ"}},
    {"offset": {"line": 146, "column": 0}, "map": {"version":3,"sources":["file:///Users/bachpham/Documents/CuThongThai_Calendar/src/ai_analyst.js"],"sourcesContent":["const { GoogleGenerativeAI } = require(\"@google/generative-ai\");\nrequire('dotenv').config();\n\nconst genAI = new GoogleGenerativeAI(process.env.GEMINI_API_KEY);\n\n// Priority list of models to try\nconst MODELS_TO_TRY = [\n    \"gemini-2.0-flash\",\n    \"gemini-pro-latest\",\n    \"gemini-1.5-flash\",\n    \"gemini-1.5-flash-001\",\n    \"gemini-pro\",\n    \"gemini-1.0-pro\"\n];\n\nasync function getFinancialCommentary(eventData, deviationData, context = { past: [], future: [] }) {\n\n    // Prepare Prompt Once\n    const pastStr = context.past?.map(e => `- ${e.event_time?.slice(0, 10)}: ${e.event_name} (Act: ${e.actual})`).join('\\n') || \"\";\n    const futureStr = context.future?.map(e => `- ${e.event_time?.slice(0, 10)}: ${e.event_name} (Impact: ${e.impact_level})`).join('\\n') || \"\";\n\n    const prompt = `\n    Vai trò: Cú Thông Thái.\n    SỰ KIỆN: ${eventData.event_name} (Act: ${eventData.actual} / Fcst: ${eventData.forecast})\n    BỐI CẢNH: \n    ${pastStr}\n    ${futureStr}\n    \n    NHIỆM VỤ: Trả về JSON.\n    Sentiment: BULLISH | BEARISH | NEUTRAL.\n    Commentary: Nhận định ngắn dưới 80 từ.\n    VN_Impact: Tác động tới VN-Index/Tỷ giá.\n    \n    OUTPUT JSON:\n    { \"commentary\": \"...\", \"sentiment\": \"...\", \"vn_impact\": \"...\" }\n    `;\n\n    console.log(`[AI] Starting analysis for ${eventData.event_name}...`);\n\n    let lastError = null;\n\n    // Retry Logic with Model Fallback\n    for (const modelName of MODELS_TO_TRY) {\n        try {\n            console.log(`[AI] Attempting with model: ${modelName}`);\n            const model = genAI.getGenerativeModel({ model: modelName });\n            const result = await model.generateContent(prompt);\n            const text = result.response.text().replace(/```json/g, '').replace(/```/g, '').trim();\n\n            // Try Parse JSON\n            let json;\n            try {\n                json = JSON.parse(text);\n            } catch (e) {\n                console.warn(`[AI] JSON Parse failed for ${modelName}, using raw text.`);\n                json = { commentary: text };\n            }\n\n            console.log(`[AI] Success with ${modelName}`);\n            return {\n                commentary: json.commentary,\n                sentiment: json.sentiment || \"NEUTRAL\",\n                vn_impact: json.vn_impact || json.assessment || \"Chưa có đánh giá chi tiết\"\n            };\n\n        } catch (error) {\n            console.warn(`[AI] Failed with ${modelName}: ${error.message}`);\n            lastError = error;\n            // Continue to next model\n        }\n    }\n\n    // If all failed\n    console.error(\"!!! ALL AI MODELS FAILED !!!\", lastError);\n\n    let userMessage = \"Lỗi hệ thống AI (All Models Failed)\";\n    if (lastError?.message?.includes(\"429\") || lastError?.message?.includes(\"Quota\")) {\n        userMessage = \"AI đang quá tải (Rate Limit). Vui lòng đợi 30s rồi thử lại.\";\n    } else if (lastError?.message?.includes(\"404\")) {\n        userMessage = \"Model không khả dụng (404). Kiểm tra lại Region/API Key.\";\n    }\n\n    return {\n        commentary: \"Cú đang mất kết nối vệ tinh...\",\n        sentiment: \"NEUTRAL\",\n        vn_impact: userMessage\n    };\n}\n\nmodule.exports = { getFinancialCommentary };\n"],"names":[],"mappings":"AAAA,MAAM,EAAE,kBAAkB,EAAE;AAC5B,8FAAkB,MAAM;AAExB,MAAM,QAAQ,IAAI,mBAAmB,QAAQ,GAAG,CAAC,cAAc;AAE/D,iCAAiC;AACjC,MAAM,gBAAgB;IAClB;IACA;IACA;IACA;IACA;IACA;CACH;AAED,eAAe,uBAAuB,SAAS,EAAE,aAAa,EAAE,UAAU;IAAE,MAAM,EAAE;IAAE,QAAQ,EAAE;AAAC,CAAC;IAE9F,sBAAsB;IACtB,MAAM,UAAU,QAAQ,IAAI,EAAE,IAAI,CAAA,IAAK,CAAC,EAAE,EAAE,EAAE,UAAU,EAAE,MAAM,GAAG,IAAI,EAAE,EAAE,EAAE,UAAU,CAAC,OAAO,EAAE,EAAE,MAAM,CAAC,CAAC,CAAC,EAAE,KAAK,SAAS;IAC5H,MAAM,YAAY,QAAQ,MAAM,EAAE,IAAI,CAAA,IAAK,CAAC,EAAE,EAAE,EAAE,UAAU,EAAE,MAAM,GAAG,IAAI,EAAE,EAAE,EAAE,UAAU,CAAC,UAAU,EAAE,EAAE,YAAY,CAAC,CAAC,CAAC,EAAE,KAAK,SAAS;IAEzI,MAAM,SAAS,CAAC;;aAEP,EAAE,UAAU,UAAU,CAAC,OAAO,EAAE,UAAU,MAAM,CAAC,SAAS,EAAE,UAAU,QAAQ,CAAC;;IAExF,EAAE,QAAQ;IACV,EAAE,UAAU;;;;;;;;;IASZ,CAAC;IAED,QAAQ,GAAG,CAAC,CAAC,2BAA2B,EAAE,UAAU,UAAU,CAAC,GAAG,CAAC;IAEnE,IAAI,YAAY;IAEhB,kCAAkC;IAClC,KAAK,MAAM,aAAa,cAAe;QACnC,IAAI;YACA,QAAQ,GAAG,CAAC,CAAC,4BAA4B,EAAE,WAAW;YACtD,MAAM,QAAQ,MAAM,kBAAkB,CAAC;gBAAE,OAAO;YAAU;YAC1D,MAAM,SAAS,MAAM,MAAM,eAAe,CAAC;YAC3C,MAAM,OAAO,OAAO,QAAQ,CAAC,IAAI,GAAG,OAAO,CAAC,YAAY,IAAI,OAAO,CAAC,QAAQ,IAAI,IAAI;YAEpF,iBAAiB;YACjB,IAAI;YACJ,IAAI;gBACA,OAAO,KAAK,KAAK,CAAC;YACtB,EAAE,OAAO,GAAG;gBACR,QAAQ,IAAI,CAAC,CAAC,2BAA2B,EAAE,UAAU,iBAAiB,CAAC;gBACvE,OAAO;oBAAE,YAAY;gBAAK;YAC9B;YAEA,QAAQ,GAAG,CAAC,CAAC,kBAAkB,EAAE,WAAW;YAC5C,OAAO;gBACH,YAAY,KAAK,UAAU;gBAC3B,WAAW,KAAK,SAAS,IAAI;gBAC7B,WAAW,KAAK,SAAS,IAAI,KAAK,UAAU,IAAI;YACpD;QAEJ,EAAE,OAAO,OAAO;YACZ,QAAQ,IAAI,CAAC,CAAC,iBAAiB,EAAE,UAAU,EAAE,EAAE,MAAM,OAAO,EAAE;YAC9D,YAAY;QACZ,yBAAyB;QAC7B;IACJ;IAEA,gBAAgB;IAChB,QAAQ,KAAK,CAAC,gCAAgC;IAE9C,IAAI,cAAc;IAClB,IAAI,WAAW,SAAS,SAAS,UAAU,WAAW,SAAS,SAAS,UAAU;QAC9E,cAAc;IAClB,OAAO,IAAI,WAAW,SAAS,SAAS,QAAQ;QAC5C,cAAc;IAClB;IAEA,OAAO;QACH,YAAY;QACZ,WAAW;QACX,WAAW;IACf;AACJ;AAEA,OAAO,OAAO,GAAG;IAAE;AAAuB"}},
    {"offset": {"line": 234, "column": 0}, "map": {"version":3,"sources":["file:///Users/bachpham/Documents/CuThongThai_Calendar/app/api/analyze/route.js"],"sourcesContent":["import { createClient } from '@supabase/supabase-js';\nimport { NextResponse } from 'next/server';\nimport { compareEventData } from '../../../src/logic_processor';\nimport { getFinancialCommentary } from '../../../src/ai_analyst';\n\nexport async function POST(request) {\n    const supabaseUrl = process.env.SUPABASE_URL;\n    const supabaseKey = process.env.SUPABASE_KEY;\n\n    if (!supabaseUrl || !supabaseKey) {\n        return NextResponse.json({ error: 'Supabase credentials missing' }, { status: 500 });\n    }\n\n    const supabase = createClient(supabaseUrl, supabaseKey);\n\n    try {\n        const { event_id } = await request.json();\n\n        // 1. Fetch event from DB\n        const { data: event, error: fetchError } = await supabase\n            .from('economic_events')\n            .select('*')\n            .eq('id', event_id)\n            .single();\n\n        if (fetchError || !event) throw new Error('Event not found');\n\n        // 2a. Fetch Context (Past 7 Days)\n        const sevenDaysAgo = new Date(Date.now() - 7 * 24 * 60 * 60 * 1000).toISOString();\n        const { data: pastContext } = await supabase\n            .from('economic_events')\n            .select('event_name, actual, forecast, event_time')\n            .gte('event_time', sevenDaysAgo)\n            .lt('event_time', new Date().toISOString())\n            .not('actual', 'is', null) // Only completed events\n            .order('event_time', { ascending: false })\n            .limit(10);\n\n        // 2b. Fetch Context (Future 7 Days - High Impact Only)\n        const sevenDaysFuture = new Date(Date.now() + 7 * 24 * 60 * 60 * 1000).toISOString();\n        const { data: futureContext } = await supabase\n            .from('economic_events')\n            .select('event_name, forecast, event_time, impact_level')\n            .gt('event_time', new Date().toISOString())\n            .lte('event_time', sevenDaysFuture)\n            .eq('impact_level', 'High') // Only High impact\n            .order('event_time', { ascending: true })\n            .limit(5);\n\n        // 3. Run Logic\n        const analysis = compareEventData(event);\n        if (analysis.status !== \"COMPLETED\") {\n            return NextResponse.json({ error: 'Analysis failed (missing data?)', details: analysis }, { status: 400 });\n        }\n\n        // 4. Run AI with Context\n        const context = {\n            past: pastContext || [],\n            future: futureContext || []\n        };\n        const aiResult = await getFinancialCommentary(event, analysis, context);\n\n        // 4. Update DB\n        const { data: updatedEvent, error: updateError } = await supabase\n            .from('economic_events')\n            .update({\n                ai_commentary: aiResult.commentary,\n                ai_sentiment: aiResult.sentiment,\n                vn_impact: aiResult.vn_impact || \"Chưa có đánh giá chi tiết\",\n                updated_at: new Date().toISOString()\n            })\n            .eq('id', event_id)\n            .select()\n            .single();\n\n        if (updateError) throw updateError;\n\n        return NextResponse.json(updatedEvent);\n\n    } catch (error) {\n        console.error(\"AI Analyze Error:\", error);\n        return NextResponse.json({ error: error.message }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,KAAK,OAAO;IAC9B,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAC5C,MAAM,cAAc,QAAQ,GAAG,CAAC,YAAY;IAE5C,IAAI,CAAC,eAAe,CAAC,aAAa;QAC9B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAA+B,GAAG;YAAE,QAAQ;QAAI;IACtF;IAEA,MAAM,WAAW,IAAA,gMAAY,EAAC,aAAa;IAE3C,IAAI;QACA,MAAM,EAAE,QAAQ,EAAE,GAAG,MAAM,QAAQ,IAAI;QAEvC,yBAAyB;QACzB,MAAM,EAAE,MAAM,KAAK,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,SAC5C,IAAI,CAAC,mBACL,MAAM,CAAC,KACP,EAAE,CAAC,MAAM,UACT,MAAM;QAEX,IAAI,cAAc,CAAC,OAAO,MAAM,IAAI,MAAM;QAE1C,kCAAkC;QAClC,MAAM,eAAe,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK,KAAK,KAAK,MAAM,WAAW;QAC/E,MAAM,EAAE,MAAM,WAAW,EAAE,GAAG,MAAM,SAC/B,IAAI,CAAC,mBACL,MAAM,CAAC,4CACP,GAAG,CAAC,cAAc,cAClB,EAAE,CAAC,cAAc,IAAI,OAAO,WAAW,IACvC,GAAG,CAAC,UAAU,MAAM,MAAM,wBAAwB;SAClD,KAAK,CAAC,cAAc;YAAE,WAAW;QAAM,GACvC,KAAK,CAAC;QAEX,uDAAuD;QACvD,MAAM,kBAAkB,IAAI,KAAK,KAAK,GAAG,KAAK,IAAI,KAAK,KAAK,KAAK,MAAM,WAAW;QAClF,MAAM,EAAE,MAAM,aAAa,EAAE,GAAG,MAAM,SACjC,IAAI,CAAC,mBACL,MAAM,CAAC,kDACP,EAAE,CAAC,cAAc,IAAI,OAAO,WAAW,IACvC,GAAG,CAAC,cAAc,iBAClB,EAAE,CAAC,gBAAgB,QAAQ,mBAAmB;SAC9C,KAAK,CAAC,cAAc;YAAE,WAAW;QAAK,GACtC,KAAK,CAAC;QAEX,eAAe;QACf,MAAM,WAAW,IAAA,4IAAgB,EAAC;QAClC,IAAI,SAAS,MAAM,KAAK,aAAa;YACjC,OAAO,gJAAY,CAAC,IAAI,CAAC;gBAAE,OAAO;gBAAmC,SAAS;YAAS,GAAG;gBAAE,QAAQ;YAAI;QAC5G;QAEA,yBAAyB;QACzB,MAAM,UAAU;YACZ,MAAM,eAAe,EAAE;YACvB,QAAQ,iBAAiB,EAAE;QAC/B;QACA,MAAM,WAAW,MAAM,IAAA,6IAAsB,EAAC,OAAO,UAAU;QAE/D,eAAe;QACf,MAAM,EAAE,MAAM,YAAY,EAAE,OAAO,WAAW,EAAE,GAAG,MAAM,SACpD,IAAI,CAAC,mBACL,MAAM,CAAC;YACJ,eAAe,SAAS,UAAU;YAClC,cAAc,SAAS,SAAS;YAChC,WAAW,SAAS,SAAS,IAAI;YACjC,YAAY,IAAI,OAAO,WAAW;QACtC,GACC,EAAE,CAAC,MAAM,UACT,MAAM,GACN,MAAM;QAEX,IAAI,aAAa,MAAM;QAEvB,OAAO,gJAAY,CAAC,IAAI,CAAC;IAE7B,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,qBAAqB;QACnC,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO,MAAM,OAAO;QAAC,GAAG;YAAE,QAAQ;QAAI;IACrE;AACJ"}}]
}